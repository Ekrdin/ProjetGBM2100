

#include "project.h"
#include "GUI.h"
#include "pervasive_eink_hardware_driver.h"
#include "cy_eink_library.h"
#include "LCDConf.h"
#include <stdlib.h>
#include "FreeRTOS.h"
#include "task.h"
#include "semphr.h"
#include "params.h"
#include "queue.h"
#include "CAPSENS.h"
#include "DISPLAY.h"
#include "arm_math.h"
#include "core_cm4.h"



char buffer[100]="";
char buffer_0[100]="";
char buffer_1[100]="";
int taille_rouge;
int taille_infrarouge; 
uint32_t ROUGE[]={205973,207305,206168,208001,206188,208050,206371,208225,206544,208577,206719,208501,206990,208473,207183,208417,207367,208379,207724,208151,207986,207993,208303,207802,208682,207622,208730,207587,209365,207455,209209,207541,209337,207549,209635,207806,209501,207957,209461,207996,209317,208103,209140,208491,209000,208672,208748,209006,208491,209357,208350,209326,208242,209947,208089,209826,208216,210028,208306,210395,208429,210203,208596,210292,208686,210169,208954,210055,209354,209987,209644,209821,210027,209660,210440,209483,210556,209554,211304,209484,211253,209696,211585,209817,211970,210011,211842,210178,211772,209972,211207,209606,210230,208954,209085,208043,207710,207263,206266,206439,205001,205392,203820,204970,202756,203955,202073,203512,201459,203377,201194,202759,200993,202713,201002,202459,201198,202302,201513,202188,201835,202108,202327,202081,202824,201965,203003,202176,203932,202267,203918,202500,204436,202777,204921,203032,204880,203312,205157,203520,205057,203810,205034,204221,204997,204527,204912,204994,204917,205416,204837,205671,204732,206338,204657,206251,204614,206460,204591,206662,204581,206367,204586,206402,204548,205967,204548,205683,204576,205312,204550,204995,204844,204647,205035,204328,205121,204143,205709,203943,205474,203995,205910,204074,206112,204207,205943,204379,206337,204543,206193,204879,206211,205289,206165,205581,206150,206104,206141,206566,206010,206910,206113,207618,206076,207602,206252,208240,206424,208563,206665,208406,206886,208919,207081,208835,207367,208762,207638,208729,207896,208526,208348,208387,208732,208203,209019,208070,209391,207916,209311,207900,209782,207913,209978,208038,209863,208165,210137,208232,209963,208477,209827,208599,209678,208829,209472,209224,209399,209521,209079,209731,208932,210161,208772,210177,208810,210728,208819,210815,208995,210858,209138,211288,209319,211079,209575,211060,209773,210901,209995,210738,210439,210645,210706,210529,211089,210404,211618,210365,211667,210429,212263,210423,212435,210609,212498,210811,212917,210990,212716,211242,212775,211454,212706,211741,212553,212006,212075,211822,211394,211512,210369,211017,209260,210003,208265,209523,207043,208474,206230,207583,205368,207020,204742,206069,204125,205441,203797,204749,203574,204319,203623,203937,203726,203711,204060,203522,204535,203455,204648,203514,205413,203600,205487,203925,205838,204139,206355,204422,206331,204765,206340,204905,206310,205237,206250,205671,206162,205966,205968,206378,205974,206914,205810,207094,205989,207848,206030,207872,206243,208126,206361,208540,206469,208161,206571,208104,206495,207865,206553,207469,206683,207157,206675,206745,206985,206432,207161,205979,207035,205823,207540,205630,207319,205637,207490,205725,207795,205872,207640,206063,207704,206191,207660,206451,207570,206852,207480,207082,207399,207523,207226,207973,207110,208152,207223,208946,207143,208810,207353,209287,207568,209686,207753,209513,208047,209837,208178,209768,208528,209740,208807,209638,209102,209523,209624,209366,210012,209201,210201,209221,210869,209090,210717,209231,211127,209364,211505,209471,211253,209641,211502,209749,211284,210005,211154,210212,210911,210296,210704,210713,210535,211061,210301,211173,210189,211774,210039,211600,210189,212038,210190,212362,210297,212096,210407,212316,210475,212075,210711,211948,210956,211803,211212,211653,211541,211458,211950,211297,212162,211147,212676,211065,212538,211107,213028,211128,213309,211291,213136,211550,213521,211655,213358,211962,213213,212192,213126,212324,212892,212745,212641,212897,212237,212817,211647,212736,210700,211734,209874,211225,208833,210424,207895,209190,207005,208490,206174,207482,205680,206645,205094,205800,204742,205171,204714,204613,204625,204101,204717,203793,205149,203572,205005,203696,205554,203726,205828,203942,205803,204307,206380,204622,206388,205060,206559,205421,206533,205667,206535,206180,206481,206490,206292,206883,206160,207464,206115,207521,206292,208305,206402,208474,206687,208511,206872,208939,206992,208721,207152,208503,207163,208264,207233,207947,207416,207560,207525,207132,207592,206828,207877,206444,207676,206334,208139,206136,207901,206112,207857,206140,208169,206238,207931,206358,207820,206447,207713,206638,207466,206977,207303,207277,207192,207706,207081,208103,206973,208188,207054,208950,207122,209005,207357,209176,207559,209677,207752,209623,208115,209711,208280,209649,208588,209549,208922,209296,209159,209208,209510,209029,209986,208906,210092,208903,210711,208890,210682,209036,210928,209164,211335,209311,211094,211720,211030,209525,210907,209785,210764,210028,210524,210284,210345,210516,210097,210907,209864,211006,209891,211597,209748,211450,209870,211707,209890,212048,209987,211765,210127,211854,210201,211623,210469,211470,210733,211316,210888,211118,211196,210930,211603,210667,211690,210606,212342,210484,212189,210579,212483,210694,212799,210842,212573,211019,212804,211122,212648,211327,212545,211738,212381,211884,212207,212313,211997,212555,211697,212417,211130,212474,210392,211663,209582,210986,208536,210186,207596,208845,206687,208006,205810,206859,205077,205887,204565,204967,204035,204126,203888,203512,203845,202960,203738,202628,204118,202439,203935,202488,204343,202575,204707,202795,204640,203013,205052,203336,204937,203668,204977,204040,204969,204330,204876,204830,204776,205237,204682,205516,204642,206110,204556,206120,204730,206553,204767,206984,205086,206843,205306,207283,205514,207187,205758,207073,206036,206817,205965,206536,206288,206252,206480,205757,206476,205521,206800,205189,206481,205014,206753,204868,206842,204892,206576,204847,206794,204864,206512,204991,206368,205193,206259,205479,206067,205917,206011,206185,205832,206505,205736,207049,205641,207054,205744,207677,205808,207841,205975,207873,206220,208307,206433,208201,206816,208156,206957,208166,207280,207951,207650,207851,207951,207751,208318,207524,208751,207360,208732,207447,209377,207486,209448,207647,209547,207845,209949,208064,209884,208361,209769,208443,209677,208653,209502,209006,209346,209267,209108,209543,208882,209991,208717,209936,208778,210564,208710,210582,208885,210665,208980,211015,209119,210898,209304,210890,209478,210768,209613,210563,209998,210388,210286,210144,210565,210008,210988,209826,210946,209720,211636,209803,211609,209905,211789,210059,212260,210340,212156,210567,212254,210845,212192,211165,212252,211804,212405,212285,212545,212971,212673,213594,212600,213848,212870,214737,212927,214762,213232,215114,213355,215520,213428,214996,213115,214297,212290,213075,211348,211815,210476,210447,209470,209150,208748,207828,208024,206645,207233,205750,207023}; 
uint32_t INFRAROUGE[]= {104833,106728,104750,106900,104859,106715,104996,106998,105087,106747,105282,106670,105384,106449,105583,106236,105874,105989,106046,105773,106340,105588,106779,105421,106689,105365,107275,105415,107416,105537,107377,105663,107789,105854,107607,106111,107576,106267,107470,106428,107254,106798,107015,106927,106600,106931,106109,106854,105157,105988,104331,105659,103285,104694,102531,103875,101748,103413,101058,102421,100581,101744,100044,101034,99736,100396,99662,99899,99535,99408,99661,99101,100006,98835,99914,98810,100602,98824,100574,98983,100855,99200,101387,99481,101243,99737,101349,99957,101375,100263,101393,100672,101257,100947,101129,101330,101047,101773,100828,101846,100819,102572,100846,102515,101010,102903,101134,103279,101269,103059,101425,103051,101434,102899,101531,102590,101672,102250,101701,101871,101939,101563,102142,101206,102042,101010,102575,100774,102300,100703,102486,100623,102719,100709,102410,100726,102547,100839,102311,101042,102210,101249,101993,101492,101895,101832,101661,102251,101571,102405,101477,103105,101496,103058,101701,103547,101775,103957,101966,103845,102219,104210,102423,104009,102689,104000,102985,103854,103168,103778,103671,103579,103997,103359,104156,103304,104778,103155,104658,103192,105044,103192,105335,103345,105145,103519,105484,103612,105181,103792,105012,103943,104851,104055,104656,104363,104383,104625,104205,104811,104010,105295,103803,105146,103850,105747,103866,105951,103896,105715,104059,106116,104117,105839,104417,105742,104475,105584,104722,105454,105077,105262,105339,105067,105622,104904,106135,104727,106068,104784,106647,104818,106749,104938,106743,105067,107158,105197,106971,105480,106970,105662,106778,105841,106705,106239,106517,106433,106224,106590,105763,106504,104858,105646,103944,105302,102995,104294,102094,103396,101268,102972,100620,101989,100099,101275,99496,100503,99218,99912,99073,99321,99061,98877,99052,98484,99394,98249,99326,98207,99965,98128,99970,98368,100209,98579,100736,98818,100694,99140,100804,99393,100838,99711,100752,100153,100659,100369,100554,100778,100463,101229,100240,101295,100300,102084,100325,102055,100453,102362,100667,102819,100781,102559,100985,102652,100949,102363,101073,102075,101258,101749,101176,101407,101418,101028,101677,100592,101460,100443,102052,100162,101764,100142,101926,100070,102198,100110,101801,100214,102004,100305,101782,100535,101734,100738,101525,100925,101302,101432,101235,101810,101108,102004,101124,102752,101069,102706,101271,103111,101373,103540,101730,103480,101946,103887,102188,103794,102469,103815,102819,103759,103065,103621,103582,103592,104019,103431,104291,103447,104960,103338,104932,103486,105357,103625,105724,103841,105643,104070,105990,104142,105819,104504,105761,104700,105607,104902,105506,105357,105429,105743,105292,106125,105318,106676,105269,106718,105475,107316,105554,107661,105724,107525,105931,108012,106129,107759,106412,107758,106654,107698,106836,107588,107301,107482,107630,107345,107897,107256,108513,107169,108490,107244,109108,107257,109191,107401,109172,107573,109591,107710,109467,107960,109476,108204,109348,108513,109350,108950,109296,109295,109150,109681,109112,110076,108790,109838,108318,109753,107299,108532,106135,107321,105021,106520,104093,105288,103327,104290,102568,103439,101925,102608,101724,101859,101399,101230,101345,100754,101497,100261,101338,100192,101975,100079,101812,100234,102005,100363,102533,100697,102503,101015,102637,101280,102674,101592,102734,102160,102708,102471,102663,102973,102663,103449,102485,103608,102647,104399,102637,104382,102882,104797,103120,105362,103395,105237,103720,105349,103761,105138,103895,104948,104039,104540,103968,104094,104003,103644,104197,103200,104015,102901,104409,102544,104059,102404,104185,102346,104391,102425,103990,102431,104169,102479,103854,102586,103754,102828,103604,102988,103374,103387,103204,103753,103119,104000,103137,104697,103025,104596,103239,105116,103365,105591,103706,105420,103953,105944,104244,105809,104533,105801,104829,105773,105238,105726,105616,105552,105936,105358,106144,105309,106757,105214,106639,105297,107121,105336,107422,105496,107265,105667,107625,105785,107384,105991,107288,106208,107149,106333,106974,106828,106805,107073,106661,107338,106559,107849,106391,107820,106422,108291,106435,108459,106528,108270,106565,108613,106605,108248,106781,108159,106845,107943,107003,107696,107381,107443,107513,107239,107770,107053,108253,106954,108273,107004,108823,106980,108924,107098,108872,107176,109297,107397,109097,107617,109089,107772,109002,108024,108917,108423,108724,108666,108460,108847,108110,108980,107450,108275,106654,107988,105580,106900,104674,105990,103780,105365,103023,104378,102434,103553,101814,102746,101443,102128,101288,101483,101116,101053,101269,100663,101539,100430,101435,100338,102074,100296,102069,100492,102326,100734,102832,100999,102843,101381,103060,101624,103109,102024,103120,102443,103165,102806,103048,103335,102971,103807,102906,103916,102989,104752,103001,104763,103259,105184,103481,105667,103697,105439,103872,105599,103827,105257,103951,104964,104021,104586,104079,104204,104108,103771,104234,103306,104152,103120,104581,102765,104306,102729,104411,102658,104676,102675,104371,102714,104599,102825,104340,102990,104129,103172,103961,103353,103843,103739,103636,104063,103515,104314,103440,104995,103383,104954,103550,105436,103732,105821,103928,105773,104202,106133,104367,106010,104722,106013,105027,105974,105243,105846,105749,105763,106084,105624,106343,105564,106926,105477,106868,105493,107431,105574,107702,105690,107456,105926,107886,106013,107712,106199,107569,106344,107282,106451,107119,106832,106893,107060,106618,107197,106485,107672,106230,107520,106261,108083,106219,108228,106358,108069,106495,108579,106580,108306,106849,108225,106951,108070,107189,107937,107498,107812,107712,107560,108010,107382,108433,107132,108437,107183,109059,107166,108989,107314,109128,107439,109543,107597,109266,107712,109123,107548,108564,107189,107652,106653,106550,105885,105319,105190,104182,104642,103064,103713,102172,103601,101399,102825,100888,102432,100466,102299,100214,101805,100116,101555,100067,101262,100118,101152,100424,100969,100653,100838,101164,100736,101602,100713,101761,100828,102601,100881,102655,101161,103023,101415,103526,101600,103393,101936,103665,102168,103644,102436,103597,102894,103505,103102,103402,103566,103330,104011,103203,104147,103140,104715,102992,104561,102924,104657,102856,104797,102798,104407,102753,104434,102618,104028,102582,103758,102664,103329,102624,102958,102909,102645,103073,102316}; 
uint8 imageBufferCache[CY_EINK_FRAME_SIZE] = {0}; 

void isr_bouton(void)
{
 

            if ( currentScreen.screen ==  PRINCIPAL_PAGE) {
            currentScreen.FLAG_DEPART = 1;
            currentScreen.TYPEGRAPH=!currentScreen.TYPEGRAPH;   
         }
            
            if ( currentScreen.screen == MAIN_MENU) {currentScreen.FLAG_DEPART=1;}  
     

            if ( currentScreen.screen == OPTION_1 || currentScreen.screen == OPTION_2 || currentScreen.screen == OPTION_3_inferieur || currentScreen.screen == OPTION_3_superieur || currentScreen.screen == OPTION_3_ETAT ) 
                {currentScreen.FLAG3=1;}
    
    CyDelay(100);
    Cy_GPIO_ClearInterrupt(bouton_0_PORT,bouton_0_NUM);
    NVIC_ClearPendingIRQ(bouton_isr_cfg.intrSrc);
    
}

int main(void)
{
    __enable_irq(); /* Enable global interrupts. */
    Cy_SysInt_Init(&bouton_isr_cfg, isr_bouton);
    NVIC_ClearPendingIRQ(bouton_isr_cfg.intrSrc);
    NVIC_EnableIRQ(bouton_isr_cfg.intrSrc);
    
    UART_1_Start();
    
    Cy_GPIO_Write (Pin_ACC_0_PORT,Pin_ACC_0_NUM,1);
    Cy_GPIO_Write (Pin_FC_0_PORT,Pin_FC_0_NUM,1);
    
    courant= 0;
    taille_infrarouge= sizeof(INFRAROUGE)/sizeof(INFRAROUGE[0]); 
    taille_rouge= sizeof(ROUGE)/sizeof(ROUGE[0]); 
    yassine= true; 
    andree= 111; 
    borne_inferieur=70; 
    borne_superieur=110; 
    etat=100;
    bouton=9; 
    
    currentScreen.screen = PRINCIPAL_PAGE;
    currentScreen.FLAG1 = 0;
    currentScreen.FLAG2 = 0;
    currentScreen.FLAG3 = 0;
    currentScreen.FLAG_DEPART = 1;
    currentScreen.TYPEGRAPH = 1;          // 0(ROUGE) et 1(INFRAROUGE)
    selection_MENU=0; 
    postion_MENU=0; 
    
    CapSense_Start();
    CapSense_ScanAllWidgets();
    
   xTaskCreate(capSense_task,"capSense_task",500,NULL,1,0);
   xTaskCreate(display_task,"display",600,NULL,2,0);
   vTaskStartScheduler();
  
    
    for(;;) { }
}

/* [] END OF FILE */

